# GitOps
Загружаемся, используя скаченный ISO образ. Нас встречает tty сессия от пользователя nixos. Я рекомендую сразу выполнить команду ниже и изменить пароль на любой удобный вам для работы через ssh:

```
nixos passwd
```

Подключатся по SSH не обязательно, но сильно сэкономит вам время

Также проверьте корректность настройки интернет-соединения. Оно понадобиться в дальнейшем в процессе установки. Это можно сделать, например, с помощью команды ниже:

```
ping ya.ru
```

### Note

Если вы ранее подключались по SSH к виртуальной машине, но затем по какой-то причине её удалили, у вас может возникнуть ошибка подключения. Для её устранения введите в консоль следующее (вместо VM IP введите IP адрес виртуальной машины):

```
ssh-keygen -R {VM IP}
```

### Разметка дисков с помощью disko

Установка системы начинается с разметки диска и каждый делает её по разному. Многие на этом этапе используют императивные утилиты, которые пересекаются с декларативной философией nix. Но сообщество решило и эту проблему с помощью **disko**.

Disko — созданная сообществом утилита, позволяющая записать схему распределения разделов диска в конфигруационный файл, а затем уже выполнить саму разметку. Такой способ, в купе с configuration.nix, позволяет с лёгкостью воспроизводить установку NixOS на нескольких машинах.

Итак, для начала посмотрим имеющиеся диски:

```
sudo fdisk -l
```
Результат вывода команды sudo fdisk -l

Игнорируем /dev/loop0 и видим, что название нашего диска - /dev/vda. Оно может быть и другим, в зависимости от типа и количества дисков. Например, для ssd это может быть nvme0n1, а для HDD - sda, sdb и т.п.

Теперь перейдём к разметке. На странице disko на [github](https://github.com/nix-community/disko) можно найти стандартный пример конфигурационного файла, которым мы и воспользуемся. Там же имеется множество вариантов этого файла, например с разделом подкачки или btrfs volumes. Создадим файл в каталоге tmp, назовём его disko.nix и внесём туда следующее:

```
{
  disko.devices = {
    disk = {
      my-disk = {
        device = "/dev/vda";
        type = "disk";
        content = {
          type = "gpt";
          partitions = {
            ESP = {
              type = "EF00";
              size = "500M";
              content = {
                type = "filesystem";
                format = "vfat";
                mountpoint = "/boot";
              };
            };
            root = {
              size = "100%";
              content = {
                type = "filesystem";
                format = "ext4";
                mountpoint = "/";
              };
            };
          };
        };
      };
    };
  };
}
```

В этом случае disko выделит 500 мегабайт для загрузочного раздела, а всё остальное место - под корневой. Я изменил название /dev/sda на /dev/vda. При установки на реальную ЭВМ с HDD этого делать не придётся. Сохраняем изменения и выходим.

Теперь запускаем утилиту с помощью команды ниже, где в конце указываем путь к файлу:

# DANGER ZONE!

```
sudo nix --experimental-features "nix-command flakes" run github:nix-community/disko -- --mode disko disko.nix
```

Дожидаемся завершения работы утилиты и разметка дисков завершена!

Проверить результат можно всё с той же команды для проверки имеющихся дисков:

Результат вывода команды sudo fdisk -l

Как мы можем у видеть, разметка дисков прошла успешно

### Настройка конфигурационного файла

Начнём настройку конфигурационного файла. Сгенерировать его можно следующей командой:

```
sudo nixos-generate-config --root /mnt
```

```bash
mv /mnt/etc/nixos/hardware-configuration.nix hardware-configuration.nix 

```
Далее необходимо отредактировать файл любым удобным для вас редактором, например nano или vim:

```
sudo nano /mnt/etc/nixos/configuration.nix
sudo vim /mnt/etc/nixos/configuration.nix
```

Файл достаточно объёмный и содержит множество примеров конфигурации системы. Сейчас мы не будем разбирать, что означает каждый из них, лишь отредактируем пару необходимых строчек.

1. **Сеть** \- зададим имя хоста TestNixOS и включим автозапуск сервиса networkmanager:
	```
	networking.hostName = "TestNixOS"; # Define your hostname.
	# Pick only one of the below networking options.
	# networking.wireless.enable = true;  # Enables wireless support via wpa_supplicant.
	networking.networkmanager.enable = true;  # Easiest to use and most distros use this by default.
	```
2. **Временная зона** - зададим временную зону, в которой находимся:
	```
	# Set your time zone.
	time.timeZone = "Europe/Moscow";
	```
3. **Пользователь** \- настроим пользователя, указав его имя, вместо стандартного alice, а также раскомментируем несколько нужных строк. Здесь некоторые указывают ещё и пароль пользователя, но из соображений безопасности так делать не рекомендуется:
	```
	# Define a user account. Don't forget to set a password with ‘passwd’.
	users.users.test = {
	  isNormalUser = true;
	  extraGroups = [ "wheel" ]; # Enable ‘sudo’ for the user.
	#   packages = with pkgs; [
	#     firefox
	#     tree
	#   ];
	};
	```
4. **Скачивание пакетов** - шаг не обязательный, но если вам нужно, то есть возможность перечислить все требуемые пакеты для установки. NixOS загрузит их в процессе. Этот шаг мне нужен, чтобы добавить VIM:
	```
	# List packages installed in system profile. To search, run:
	# $ nix search wget
	environment.systemPackages = with pkgs; [
	  vim # Do not forget to add an editor to edit configuration.nix! The Nano editor is also installed by default.
	#   wget
	];
	```

Наконец, сохраняем файл и выполним установку. Перед выполнением команды я рекомендую проверить интернет соединение или вовсе выполнить этот шаг на машине локально, т.к. в конце нас попросят указать пароль от root пользователя. Без него, как можно догадаться, в систему не попасть:

```
sudo nixos-install
sudo nixos-install --flake .#HomeLab1
```

В случае возникновения ошибок вернитесь к конфигурационному файлу и проверьте что всё написано в точности как у меня (точки с запятой также важны!).

Дожидаемся конца установки системы, вводим пароль от root пользователя и перезагружаемся с помощью команды `reboot`.

После завершения загрузки выполняем вход под учётной записью root, и изменяем пароль пользователю test:
